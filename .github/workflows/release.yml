name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          tools: composer:v2

      - name: Validate tag matches info.xml version
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          TAG_VERSION="${TAG#v}"
          # Use '|' delimiter to avoid escaping '/' in '</version>'
          VERSION="$(sed -n 's|.*<version>[[:space:]]*\\([^<]*\\)[[:space:]]*</version>.*|\\1|p' info.xml | head -n 1 | tr -d '[:space:]')"
          echo "Tag version: ${TAG_VERSION}"
          echo "info.xml version: ${VERSION}"
          if [ "${VERSION}" != "${TAG_VERSION}" ]; then
            echo "ERROR: tag (${TAG_VERSION}) does not match info.xml version (${VERSION})" >&2
            exit 1
          fi

      - name: Build release zip
        run: |
          chmod +x ./build-release.sh
          ./build-release.sh

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: vitid_auth0-v*.zip
